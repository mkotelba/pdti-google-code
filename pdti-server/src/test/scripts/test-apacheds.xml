<?xml version="1.0" encoding="UTF-8"?>
<project name="test-apacheds">
    <description>Ant project for the test ApacheDS instances.</description>
    
    <macrodef name="apacheds" description="Calls the ApacheDS test instance wrapper.">
        <attribute name="cmd"/>
        <attribute name="failonerror" default="true"/>
        <attribute name="spawn" default="false"/>
        <element name="java-elements" implicit="true" optional="true"/>
        <sequential>
            <java
                classname="gov.hhs.onc.pdti.test.ldap.TestApacheDsService"
                dir="${project.build.directory}"
                fork="true"
                spawn="@{spawn}">
                <classpath>
                    <pathelement path="${maven.test.classpath.value}"/>
                </classpath>
                <sysproperty key="pdti.log.dir" value="${project.test.log.dir}"/>
                <sysproperty key="pdti.test.apacheds.dir" value="${project.build.directory}/apacheds"/>
                <arg value="@{cmd}"/>
                <java-elements/>
            </java>
        </sequential>
    </macrodef>
    
    <target name="start-apacheds" description="Starts an ApacheDS test instance.">
        <apacheds cmd="start" failonerror="false" spawn="true">
            <jvmarg value="-Xms128m"/>
            <jvmarg value="-Xmx256m"/>
            <sysproperty key="com.sun.management.jmxremote" value="true"/>
            <sysproperty key="com.sun.management.jmxremote.port" value="29999"/>
            <sysproperty key="com.sun.management.jmxremote.authenticate" value="false"/>
            <sysproperty key="com.sun.management.jmxremote.ssl" value="false"/>
        </apacheds>
        <waitfor maxwait="1" maxwaitunit="minute">
            <socket server="localhost" port="20389"/>
        </waitfor>
    </target>
    
    <target name="stop-apacheds" description="Stops an ApacheDS test instance.">
        <apacheds cmd="stop"/>
        <waitfor maxwait="1" maxwaitunit="minute">
            <not>
                <socket server="localhost" port="20389"/>
            </not>
        </waitfor>
    </target>
</project>